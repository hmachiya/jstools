<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Checker pattern genertor</title>
        <link rel="stylesheet" href="style.css" />    
        <script>
            var checkers_horizontal=[];
            var checkers_vertical=[];
            var display_scale=1;
            var nrepeat=10;
            var color_presets=["#333333", "#41456f", "#25453d", "#46477d","#8462be","#eeeeee"]
            var colorpicker_index=-1;
            checkers_horizontal.push({
                "size": [10],
                "color": [1]
            });
            checkers_horizontal.push({
                "size": [4,2,4],
                "color": [1,5,1]
            });
            checkers_horizontal.push({
                "size": [10],
                "color": [1]
            });
            checkers_horizontal.push({
                "size": [10],
                "color": [5]
            });
            checkers_horizontal.push({
                "size": [10],
                "color": [5]
            });
            checkers_horizontal.push({
                "size": [10],
                "color": [5]
            });
            checkers_horizontal.push({
                "size": [10],
                "color": [1]
            });
            checkers_vertical.push({
                "size": [10],
                "color": [1]
            });
            checkers_vertical.push({
                "size": [10],
                "color": [5]
            });
            checkers_vertical.push({
                "size": [10],
                "color": [5]
            });
            checkers_vertical.push({
                "size": [10],
                "color": [5]
            });
            checkers_vertical.push({
                "size": [10],
                "color": [1]
            });
            checkers_vertical.push({
                "size": [4,2,4],
                "color": [1,5,1]
            });
            checkers_vertical.push({
                "size": [10],
                "color": [1]
            });
        </script>
        <style>
            body {
                font-family: Arial, sans-serif;
            }
            .linespec {
                display: inline-block;
                width:75px;
                padding: 4px 4px;
                margin: 0px;
                border:1px solid #333;
                border-radius: 4px;
                margin: 5px;
            }
            table {
                border-collapse: collapse;
            }
            td {
                padding: 5px;
            }
            input[type="number"] {
                width: 30px;
                padding: 4px 10px;
                margin: 0px;
                border-radius: 4px;
            }
            input[type="color"] {
                width: 20px;
                height: 20px;
                padding:0px;
                border:1px solid #333;
                background: none;
                border-radius: 5px;
                margin:0px;
            }
            div.list_container {
                margin: 10px;
                padding: 10px;
                width: 350px;
                border: 1px solid #ccc;
                border-radius: 8px;
            }
            div.list_container .list_header {
                font-weight: bold;
                margin: -10px;
                margin-bottom: 10px;
                padding: 10px;
                border-bottom: 2px solid #18106c;
            }
            div#popup_dialog {
                position: fixed;
                background: rgba(0,0,0,0.95);
                opacity: 0.9;
                display: block;
                left: 0px;
                top: 0px;
                width: 100%;
                height: 100%;
                display: none;
            }
            div#popup_dialog div#dialog{
                position:fixed;
                left:100px;
                top: 100px;
                width:150px;
                background: #eeeeee;
                border:1px solid #333;
                border-radius: 3px;
                box-shadow: 2px 2px 5px rgba(0,0,0,0.9);
                padding: 5px;
            }
            div#popup_dialog div#dialog div#dialog_header {
                font-weight: bold;
                margin-bottom: 10px;
            }
            div#popup_dialog div#dialog div#dialog_content input[type="color"] {
                width: 30%;
                height: 30px;
                padding: 0px;
                border: 1px solid #333;
                background: none;
                border-radius: 5px;
            }
            div#popup_dialog div#dialog div#dialog_buttons button{
                padding: 5px 10px;
                margin: 5px;
                border: 1px solid #333;;
                border-radius: 4px;
            }            
        </style>
    </head>
    <body>
        <h1>チェッカー柄生成器</h1>
        <div id="container">
            <canvas id="canvas" width="600" height="600" style="border:1px solid #333;"></canvas>
            <div id="form" style="display: flex; flex-wrap: wrap;">
                <div class="list_container">
                    <div class="list_header">基本設定</div>
                    <table>
                        <tr>
                            <th>表示サイズ</th>
                            <td><input type="number" id="display_scale" value="1" min="0.1" step="0.1" style="width:50px;" onchange="display_scale=parseFloat(this.value); drawCheckerboard();" /></td>
                        </tr>
                        <tr>
                            <th>繰り返し数</th>
                            <td><input type="number" id="nrepeat" value="10" min="1" step="1" style="width:50px;"  onchange="nrepeat=parseInt(this.value); drawCheckerboard();" /></td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <button onclick="drawCheckerboard();">表示更新</button>
                            </td>
                        </tr>
                    </table>
                    <div id="color_list"></div>
                </div>
                <div class="list_container">
                    <div class="list_header">垂直ライン</div>
                    <div id="vline_list"></div>
                    <button onclick="readAllLineSpec();">色設定反映</button>
                </div>
                <div class="list_container">
                    <div class="list_header">水平ライン</div>
                    <div id="hline_list"></div>
                    <button onclick="readAllLineSpec();">色設定反映</button>
                </div>
            </div>
        </div>
        <div id="popup_dialog">
            <div id="dialog">
                <div id="dialog_header">
                    色選択
                </div>
                <div id="dialog_content">
                    <input type="color" id="color_picker" value="#000000" />
                </div>
                <div id="dialog_buttons">
                    <button onclick="colorpicker_ok()">OK</button><button onclick="colorpicker_cancel()">Cancel</button>
                </div>
            </div>
        </div>
        <script>
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');
            var centerX = canvas.width / 2;
            var centerY = canvas.height / 2;
            function drawCheckerboard() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#FFFFFF';
                xpos=0;
                ypos=0;
                checker_width = 0;
                checker_height = 0;
                for(var i=0; i<checkers_horizontal.length; i++) {
                    for(var j=0; j<checkers_horizontal[i].size.length; j++) {
                        checker_height += checkers_horizontal[i].size[j] * nrepeat * display_scale;
                    }
                }
                for(var i=0; i<checkers_vertical.length; i++) {
                    for(var j=0; j<checkers_vertical[i].size.length; j++) {
                        checker_width += checkers_vertical[i].size[j] * nrepeat * display_scale;
                    }
                }
                if(checker_width === 0 || checker_height === 0) {
                    return;
                }
                var cell_height=0;
                var cell_width=0;
                for(var ix=0; ix<checkers_horizontal.length*nrepeat; ix++) {
                    xpos=0;
                    for(var iy=0; iy<checkers_vertical.length*nrepeat; iy++) {
                        cellh=checkers_horizontal[ix%checkers_horizontal.length];
                        cellv=checkers_vertical[iy%checkers_vertical.length];
                        cell_height = 0;
                        cell_width = 0;
                        for(var j=0; j<cellh.size.length; j++) {
                            cell_height += cellh.size[j] * display_scale;
                        }
                        for(var j=0; j<cellv.size.length; j++) {
                            cell_width += cellv.size[j] * display_scale;
                        }
                        if((ix+iy) % 2 === 0) {
                            //horizontal
                            var cell_inner_pos=0;
                            for(var j=0; j<cellh.color.length; j++) {
                                ctx.fillStyle =color_presets[cellh.color[j]];
                                ctx.fillRect(centerX - checker_width/2 + xpos, centerY - checker_height/2 + ypos + cell_inner_pos, cell_width, cellh.size[j] * display_scale);
                                cell_inner_pos += cellh.size[j] * display_scale;
                            }
                        }else{
                            //vertical
                            var cell_inner_pos=0;
                            for(var j=0; j<cellv.color.length; j++) {
                                ctx.fillStyle =color_presets[cellv.color[j]];
                                ctx.fillRect(centerX - checker_width/2 + xpos + cell_inner_pos, centerY - checker_height/2 + ypos, cellv.size[j] * display_scale, cell_height);
                                cell_inner_pos+=cellv.size[j] * display_scale;
                            }
                        }
                        xpos+=cell_width;
                    }
                    ypos+=cell_height;
                }
            } 
            function updateLineList() {
                var vline_list = document.getElementById('vline_list');
                var hline_list = document.getElementById('hline_list');
                vline_list.innerHTML = '';
                hline_list.innerHTML = '';
                var tbl = document.createElement('table');
                for(var i=0; i<checkers_vertical.length; i++) {
                    var tr = document.createElement('tr');
                    var td = document.createElement('td');
                    td.innerHTML = '';
                    for(var j=0; j<checkers_vertical[i].size.length; j++) {
                        var line="";
                        line += "<select id='cs_0_"+i+"_"+j+"'>";
                        for(var k=0; k<color_presets.length; k++) {
                            line+="<option value='"+color_presets[k]+"'"+(checkers_vertical[i].color[j] === k ? " selected" : "")+">No."+k+"</option>";
                        }
                        line += "</select>"+checkers_vertical[i].size[j] + (j < checkers_vertical[i].size.length - 1 ? ', ' : '');
                        td.innerHTML += line;
                    }
                    tr.appendChild(td);
                    var td = document.createElement('td');
                    td.innerHTML += " <button onclick='moveItem(0,"+i+",-1)'>▲</button> <button onclick='moveItem(0,"+i+",1)'>▼</button> <button onclick='deleteItem(0,"+i+")'>X</button>";
                    tr.appendChild(td);
                    tbl.appendChild(tr);
                }
                vline_list.appendChild(tbl);
                var tbl = document.createElement('table');
                for(var i=0; i<checkers_horizontal.length; i++) {
                    var tr = document.createElement('tr');
                    var td = document.createElement('td');
                    td.innerHTML = '';
                    for(var j=0; j<checkers_horizontal[i].size.length; j++) {
                        var line="";
                        line += "<select id='cs_1_"+i+"_"+j+"'>";   
                        for(var k=0; k<color_presets.length; k++) {
                            line+="<option value='"+color_presets[k]+"'"+(checkers_horizontal[i].color[j] === k ? " selected" : "")+">No."+k+"</option>";
                        }
                        line += "</select>"+checkers_horizontal[i].size[j] + (j < checkers_horizontal[i].size.length - 1 ? ', ' : '');
                        td.innerHTML += line;
                    }
                    tr.appendChild(td);
                    var td = document.createElement('td');
                    td.innerHTML += " <button onclick='moveItem(1,"+i+",-1)'>▲</button> <button onclick='moveItem(1,"+i+",1)'>▼</button> <button onclick='deleteItem(1,"+i+")'>X</button>";
                    tr.appendChild(td);
                    tbl.appendChild(tr);
                }
                hline_list.appendChild(tbl);
            }
            function addVertical(){
                var colors = [document.getElementById('vc000').value, document.getElementById('vc001').value, document.getElementById('vc002').value, document.getElementById('vc003').value, document.getElementById('vc004').value];
                var sizes = [parseInt(document.getElementById('vs000').value), parseInt(document.getElementById('vs001').value), parseInt(document.getElementById('vs002').value), parseInt(document.getElementById('vs003').value), parseInt(document.getElementById('vs004').value)];
                var filtered_colors=[];
                var filtered_sizes=[];
                for(var i=0; i<colors.length; i++) {
                    if(isNaN(sizes[i]) || sizes[i] <= 0) {
                        continue;
                    }
                    filtered_colors.push(colors[i]);
                    filtered_sizes.push(sizes[i]);
                }
                if(filtered_colors.length > 0 || filtered_sizes.length > 0) {
                    checkers_vertical.push({
                        'size': filtered_sizes,
                        'color': filtered_colors
                    });
                }
                updateLineList();
                drawCheckerboard();
            }
            function clearVertical() {
                checkers_vertical = [];
                updateLineList();
            }
            
            function addHorizontal(){
                var colors = [document.getElementById('hc000').value, document.getElementById('hc001').value, document.getElementById('hc002').value, document.getElementById('hc003').value, document.getElementById('hc004').value];
                var sizes = [parseInt(document.getElementById('hs000').value), parseInt(document.getElementById('hs001').value), parseInt(document.getElementById('hs002').value), parseInt(document.getElementById('hs003').value), parseInt(document.getElementById('hs004').value)];
                var filtered_colors=[];
                var filtered_sizes=[];
                for(var i=0; i<colors.length; i++) {
                    if(isNaN(sizes[i]) || sizes[i] <= 0) {
                        continue;
                    }
                    filtered_colors.push(colors[i]);
                    filtered_sizes.push(sizes[i]);
                }
                if(filtered_colors.length > 0 || filtered_sizes.length > 0) {
                    checkers_horizontal.push({
                        'size': filtered_sizes,
                        'color': filtered_colors
                    });
                }
                updateLineList();
                drawCheckerboard();
            }
            function clearHorizontal() {
                checkers_horizontal = [];
                updateLineList();
            }
            function moveItem(type, index, direction) {
                if(type === 0) { // vertical
                    if(index + direction >= 0 && index + direction < checkers_vertical.length) {
                        var item = checkers_vertical.splice(index, 1)[0];
                        checkers_vertical.splice(index + direction, 0, item);
                    }
                } else { // horizontal
                    if(index + direction >= 0 && index + direction < checkers_horizontal.length) {
                        var item = checkers_horizontal.splice(index, 1)[0];
                        checkers_horizontal.splice(index + direction, 0, item);
                    }
                }
                updateLineList();
                drawCheckerboard();
            }
            function deleteItem(type, index) {
                if(type === 0) { // vertical
                    checkers_vertical.splice(index, 1);
                } else { // horizontal
                    checkers_horizontal.splice(index, 1);
                }
                updateLineList();
                drawCheckerboard();
            }
            function updateColorPresets() {
                var color_list = document.getElementById('color_list');
                color_list.innerHTML = '';
                for(var i=0; i<color_presets.length; i++) {
                    var colorDiv = document.createElement('div');
                    colorDiv.className = 'linespec';
                    colorDiv.style.backgroundColor = color_presets[i];
                    colorDiv.addEventListener('click', function(event) {
                        colorpicker_index = i;
                        var dialog_window = document.getElementById('dialog');
                        var dialog = document.getElementById('popup_dialog');
                        dialog_window.style.position = 'absolute';
                        dialog_window.style.left=event.clientX+"px";
                        dialog_window.style.top=event.clientY+"px";
                        console.log(event.clientX, event.clientY);
                        dialog.style.display = 'block';
                        event.stopPropagation();
                    });
                    colorDiv.innerHTML = '<span style="color:'+color_presets[i]+'; filter: invert(100%) grayscale(100%) contrast(100);">No.' + i + ': ' + color_presets[i]+"</span>";
                    color_list.appendChild(colorDiv);
                }
            }
            function colorpicker_ok() {
                var color = document.getElementById('color_picker').value;
                if(colorpicker_index < 0 || colorpicker_index >= color_presets.length) {
                    color_presets.push(color);
                }else{
                    color_presets[colorpicker_index] = color;
                }
                updateColorPresets();
                drawCheckerboard();
                document.getElementById('popup_dialog').style.display = 'none';
            }
            function colorpicker_cancel() {
                document.getElementById('popup_dialog').style.display = 'none';
            }
            function readAllLineSpec() {
                for(var i=0; i<checkers_vertical.length; i++) {
                    for(var j=0; j<checkers_vertical[i].size.length; j++) {
                        readLineSpec(0, i, j);
                    }
                }
                for(var i=0; i<checkers_horizontal.length; i++) {
                    for(var j=0; j<checkers_horizontal[i].size.length; j++) {
                        readLineSpec(1, i, j);
                    }
                }
                drawCheckerboard();

            }
            function readLineSpec(type, i, j) {
                if(type === 0) { // vertical
                    var select = document.getElementById('cs_0_' + i + '_' + j);
                    checkers_vertical[i].color[j] = select.selectedIndex;
                } else { // horizontal
                    var select = document.getElementById('cs_1_' + i + '_' + j);
                    checkers_horizontal[i].color[j] = select.selectedIndex;
                }
            }
            updateLineList();
            updateColorPresets();
            drawCheckerboard();
        </script>
    </body>
</html>